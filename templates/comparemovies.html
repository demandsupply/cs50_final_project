{% extends "layout.html" %}

{% block title %}
    AJAX compare movies
{% endblock %}

{% block main %}

<h1 id="compareMovie">Movie Search</h1>
    
    <input type="text" id="searchMovieInput" placeholder="Enter Movie title">

    <div id="searchResults"></div>

    <div>
        <canvas id="moviesChart" style="width:100%; max-width:1200px; border: 1px solid #000;"></canvas>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="./../static/main.js"></script>
    <script>
        var currentResults = [];  // Store all search results
        var displayedResults = 10;  // Number of results to display initially
        
       
        
        function performMovieSearch() {
            var query = document.getElementById('searchMovieInput').value;
        
            $.ajax({
                type: 'POST',
                url: '/comparemovies',
                data: { q: query },
                success: function(data) {
                    currentResults = data.results;  // Assuming your API response has a 'results' property
        
                    // Display the first 'displayedResults' results
                    displayMovieResults(currentResults.slice(0, displayedResults));
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }
        
        function displayMovieResults(results) {
            var resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
        
            if (results.length === 0) {
                resultsContainer.innerHTML = 'No results found.';
                return;
            }
        
            var ul = document.createElement('ul');
            ul.classList.add("results");
            results.forEach(function(result) {
                var li = document.createElement('li');
                li.addEventListener('click', compareItemClick)
                // var link = document.createElement('a');
        
                var date2Str = result.release_date || '';
                var year2 = date2Str.split('-', 1)[0];
                li.textContent = result.title + " (" + year2 + ")";  // Shows the tv show title and its year
                li.plot = result.overview;
                li.rating = result.vote_average;
                li.poster = result.poster_path;
                // link.setAttribute('href', 'movie/'+ result.id);
                
                ul.appendChild(li);
                // li.appendChild(link);
            });
        
            resultsContainer.appendChild(ul);
        
            // close results div if the user clicks outside the div
            window.addEventListener("click", function(e) {
                if (e.target != document.querySelector(".results")) {
                    ul.remove();
                }
            });
        }

        document.getElementById("searchMovieInput").addEventListener('keyup', function(event) {
                performMovieSearch(); 
            });



        function compareItemClick(dataObtained) {
        if (window.chartInstance) {
            window.chartInstance.destroy();
        }
        console.log("display chart data started")
        <!-- const labels = ["a", "b", "c", "d"] -->
        console.log(dataObtained.target.plot)
        console.log(dataObtained.target.rating)
        console.log(dataObtained.target.poster)
        const datasss = {
            labels: dataObtained,
            datasets: [{
                data: [8.9, 4, 3.5, 9, 7]
            }
            ]
        };
        window.chartInstance =  new Chart('moviesChart', {
            type: 'bar',
            data: datasss,
            options: {
                responsive: true,
                scales: {
                    xAxes: [{ticks: {min: 0, max: 10}}],
                    yAxes: [{ticks: {min: 0, max: 10}}]
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'bar char'
                    }
                }
            }})
        ;
        }

    </script>

{% endblock %}